stages:
  - build
  - test
  - lint
  - deploy
  - notify

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Building the application..."
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker build -t $DOCKERHUB_USERNAME/$DOCKERHUB_IMAGE:latest .
    - docker push $DOCKERHUB_USERNAME/$DOCKERHUB_IMAGE:latest

test:
  stage: test
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Testing the application..."
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker pull $DOCKERHUB_USERNAME/$DOCKERHUB_IMAGE:latest
    - docker run -d --name test-app -p 80:80 $DOCKERHUB_USERNAME/$DOCKERHUB_IMAGE:latest
    - sleep 10
    - apk add --no-cache curl
    - curl -f -I http://docker || curl -f -I http://localhost

lint:
  stage: lint
  image: docker:latest
  script:
    - echo "Linting the code..."

deploy:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Deploying the application..."
    - apk add --no-cache docker-compose
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker-compose up -d

notify:
  stage: notify
  image: docker:latest
  script:
    - echo "Notifying the team..."