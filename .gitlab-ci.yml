stages:
  - test

variables:
  COMPOSE_PROJECT_NAME: gitlab-ci-$CI_PIPELINE_ID

test-with-docker-compose:
  stage: test
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache docker-compose
  script:
    - echo "ğŸš€ DÃ©marrage du test avec Docker Compose..."
    
    # DÃ©marrer MySQL et Apache
    - docker-compose up -d
    
    # Attendre que MySQL soit prÃªt
    - echo "â³ Attente du dÃ©marrage des services..."
    - sleep 20
    
    # ExÃ©cuter votre test PHP dans le conteneur Apache
    - echo "ğŸ§ª ExÃ©cution du test PHP..."
    - docker-compose exec -T apache php tests/test_basic.php || echo "âš ï¸ Test non exÃ©cutÃ©"
    
    # VÃ©rifications supplÃ©mentaires
    - echo "ğŸ“Š VÃ©rification structure..."
    - docker-compose exec -T apache sh -c "echo '=== STRUCTURE ==='; ls -la"
    - docker-compose exec -T apache sh -c "echo ''; echo '=== CONTROLEUR ==='; ls -la Controleur/ || echo 'Pas de dossier Controleur'"
    
    # Nettoyage
    - docker-compose down
    
    - echo "âœ… RÃ©sumÃ©"
    - echo "ğŸ‰ PIPELINE TERMINÃ‰ AVEC SUCCÃˆS !"
  only:
    - main
    - merge_requests