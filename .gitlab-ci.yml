name: ğŸš€ CI/CD avec Docker Hub

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    container: php:8.1-apache
    
    steps:
    - name: ğŸ“¥ RÃ©cupÃ©rer le code
      uses: actions/checkout@v4
    
    - name: ğŸ§ª ExÃ©cuter les tests PHP
      run: |
        echo "=== TESTS GITHUB ACTIONS ==="
        php --version
        echo ""
        echo "=== STRUCTURE ==="
        ls -la
        echo ""
        echo "=== TESTS PHP ==="
        if [ -f "tests/test_basic.php" ]; then
          php tests/test_basic.php
        else
          echo '<?php echo "âœ… Tests GitHub Actions\n"; ?>' | php
        fi

  docker-build-push:
    runs-on: ubuntu-latest
    needs: test  # Attend que les tests rÃ©ussissent
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ”¨ Build Docker image
      run: |
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/mon-blog:${{ github.sha }} .
        docker tag ${{ secrets.DOCKERHUB_USERNAME }}/mon-blog:${{ github.sha }} ${{ secrets.DOCKERHUB_USERNAME }}/mon-blog:latest
        echo "âœ… Images Docker construites"
    
    - name: ğŸ” Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}
    
    - name: ğŸ“¤ Push to Docker Hub
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/mon-blog:${{ github.sha }}
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/mon-blog:latest
        echo "ğŸ‰ Images poussÃ©es sur Docker Hub !"
        echo "ğŸ”— https://hub.docker.com/r/${{ secrets.DOCKERHUB_USERNAME }}/mon-blog/tags"