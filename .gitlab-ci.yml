stages:
  - test
  - build
  - push

variables:
  DOCKER_IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  DOCKER_TLS_CERTDIR: ""

# √âtape 1: Tests de l'application
test-application:
  stage: test
  image: php:8.1-apache
  script:
    - echo "üöÄ Tests de l'application..."
    
    # Tests PHP
    - php --version
    
    # V√©rification extensions
    - |
      php -r '
      $required = ["mysqli", "pdo_mysql"];
      foreach($required as $ext) {
        if(extension_loaded($ext)) {
          echo "‚úÖ $ext activ√©\n";
        } else {
          echo "‚ùå $ext manquant\n";
        }
      }
      '
    
    # V√©rification fichiers
    - ls -la
    
    - echo "üéâ Tests r√©ussis !"
  only:
    - main

# √âtape 2: Build de l'image Docker
build-docker-image:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "üî® Construction de l'image Docker..."
    - docker build -t $DOCKERHUB_IMAGE:$DOCKER_IMAGE_TAG .
    - docker tag $DOCKERHUB_IMAGE:$DOCKER_IMAGE_TAG $DOCKERHUB_IMAGE:latest
    - echo "‚úÖ Image Docker construite"
    - docker images | grep $DOCKERHUB_IMAGE
  dependencies:
    - test-application
  only:
    - main
  # SUPPRIMEZ LE TAG "docker" si probl√®me
  # tags:
  #   - docker

# √âtape 3: Push automatique sur Docker Hub
push-to-dockerhub:
  stage: push
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "üì§ Connexion √† Docker Hub..."
    - echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin
    
    - echo "üöÄ Push de l'image..."
    - docker push $DOCKERHUB_IMAGE:$DOCKER_IMAGE_TAG
    - docker push $DOCKERHUB_IMAGE:latest
    
    - echo "‚úÖ Images pouss√©es sur Docker Hub :"
    - echo "   - $DOCKERHUB_IMAGE:$DOCKER_IMAGE_TAG"
    - echo "   - $DOCKERHUB_IMAGE:latest"
    
    # Affichage de l'URL
    - echo "üîó V√©rifiez sur : https://hub.docker.com/r/${DOCKERHUB_IMAGE%%:*}/$DOCKERHUB_IMAGE/tags"
  dependencies:
    - build-docker-image
  only:
    - main
  # SUPPRIMEZ LE TAG "docker" si probl√®me
  # tags:
  #   - docker