stages:
  - test

test-with-mysql-service:
  stage: test
  image: php:8.1-apache
  services:
    - mysql:8.0  # GitLab fournit MySQL comme service
  variables:
    MYSQL_ROOT_PASSWORD: root
    MYSQL_DATABASE: monblog
    DB_HOST: mysql
    DB_USER: root
    DB_PASSWORD: root
  before_script:
    - apt-get update && apt-get install -y curl git mysql-client
    - php -v
  script:
    - echo "ðŸš€ Test avec MySQL service..."
    
    # VÃ©rifier MySQL
    - echo "=== TEST CONNEXION MYSQL ==="
    - mysql -h mysql -uroot -proot -e "SHOW DATABASES;" || echo "âš ï¸ MySQL non disponible"
    
    # Test PHP
    - echo "=== TEST PHP ==="
    - php --version
    
    # Tester la connexion PDO
    - echo "=== TEST CONNEXION PDO ==="
    - php -r "
      try {
        \$pdo = new PDO('mysql:host=mysql;dbname=monblog', 'root', 'root');
        echo 'âœ… Connexion MySQL rÃ©ussie via PDO\n';
      } catch (PDOException \$e) {
        echo 'âŒ Erreur connexion: ' . \$e->getMessage() . '\n';
      }"
    
    # Tests locaux
    - if [ -f "tests/test_basic.php" ]; then
        php tests/test_basic.php
      else
        echo "âœ… Tests basiques PHP OK"
      fi
    
    - echo "ðŸŽ‰ PIPELINE TERMINÃ‰ !"
  only:
    - main
    