image: docker:latest

services:
  - docker:dind

variables:
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  # √Ä d√©finir dans Settings > CI/CD > Variables de GitLab :
  # DOCKERHUB_USERNAME: "votre_nom"
  # DOCKERHUB_PASSWORD: "votre_token"
  # DOCKERHUB_IMAGE: "votre_nom/mon-blog"

stages:
  - build
  - test
  - push
  - deploy

before_script:
  - docker info

# √âtape 1: Build de l'image Docker
build-docker-image:
  stage: build
  script:
    - echo "üî® Construction de l'image Docker..."
    - docker build -t $DOCKERHUB_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker tag $DOCKERHUB_IMAGE:$CI_COMMIT_SHORT_SHA $DOCKERHUB_IMAGE:latest
    - echo "‚úÖ Image Docker construite"
  artifacts:
    paths:
      - ./
    expire_in: 1 hour
  only:
    - main
    - tags

# √âtape 2: Tests avec Docker Compose
test-docker-compose:
  stage: test
  script:
    - echo "üß™ Tests avec Docker Compose..."
    - apk add --no-cache docker-compose
    
    # D√©marrer les services
    - docker-compose up -d
    
    # Attendre que MySQL soit pr√™t
    - echo "‚è≥ Attente du d√©marrage de MySQL..."
    - sleep 30
    
    # Tester MySQL
    - docker-compose exec -T mysql mysql -uroot -proot -e "SHOW DATABASES;"
    
    # Tester Apache/PHP
    - docker-compose exec -T apache php --version
    
    # Tester l'application
    - |
      if [ -f "tests/test_basic.php" ]; then
        docker-compose exec -T apache php tests/test_basic.php
      else
        docker-compose exec -T apache php -r "echo '‚úÖ Application PHP fonctionne';"
      fi
    
    # Arr√™ter les services
    - docker-compose down
    
    - echo "‚úÖ Tests Docker Compose r√©ussis"
  dependencies:
    - build-docker-image
  only:
    - main
    - merge_requests

# √âtape 3: Push vers Docker Hub
push-to-dockerhub:
  stage: push
  script:
    - echo "üì§ Connexion √† Docker Hub..."
    - echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin
    
    - echo "üöÄ Push de l'image..."
    - docker push $DOCKERHUB_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKERHUB_IMAGE:latest
    
    - echo "‚úÖ Images pouss√©es sur Docker Hub :"
    - echo "   - $DOCKERHUB_IMAGE:$CI_COMMIT_SHORT_SHA"
    - echo "   - $DOCKERHUB_IMAGE:latest"
  dependencies:
    - build-docker-image
  only:
    - main
    - tags

# √âtape 4: D√©ploiement (manuel)
deploy-production:
  stage: deploy
  script:
    - echo "üöÄ D√©ploiement de la version $CI_COMMIT_SHORT_SHA..."
    - echo "üì¶ Image disponible sur Docker Hub: $DOCKERHUB_IMAGE:$CI_COMMIT_SHORT_SHA"
    - echo "üåê Pour d√©ployer :"
    - echo "   docker-compose pull"
    - echo "   docker-compose up -d"
  only:
    - main
  when: manual
  environment:
    name: production
    url: http://localhost:8081