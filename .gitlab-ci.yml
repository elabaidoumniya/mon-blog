stages:
  - test

variables:
  COMPOSE_PROJECT_NAME: gitlab-ci-$CI_PIPELINE_ID

test-with-docker-compose:
  stage: test
  image: docker/compose:latest
  services:
    - docker:dind
  tags:
    - docker
  script:
    - echo "ğŸš€ DÃ©marrage des tests..."
    
    # Ã‰tape 1: VÃ©rifier Docker
    - docker --version
    - docker-compose --version
    
    # Ã‰tape 2: DÃ©marrer les services
    - echo "ğŸ³ Lancement de Docker Compose..."
    - docker-compose up -d
    
    # Ã‰tape 3: Attendre et vÃ©rifier
    - echo "â³ Attente des services..."
    - for i in {1..10}; do
        if docker-compose ps | grep -q "Up"; then
          echo "âœ… Services dÃ©marrÃ©s"
          break
        fi
        echo "â±ï¸ Tentative $i/10..."
        sleep 5
      done
    
    # Ã‰tape 4: ExÃ©cuter les tests
    - echo "ğŸ§ª ExÃ©cution des vÃ©rifications..."
    
    # Test MySQL
    - echo "ğŸ“Š Test MySQL..."
    - docker-compose exec -T mysql mysql -uroot -proot -e "SHOW DATABASES;" || echo "âŒ MySQL non disponible"
    
    # Test PHP
    - echo "ğŸ˜ Test PHP..."
    - docker-compose exec -T apache php --version || echo "âŒ PHP non disponible"
    
    # Test fichier
    - echo "ğŸ“ Test fichiers..."
    - docker-compose exec -T apache sh -c "ls -la && echo '---' && [ -d 'Controleur' ] && ls -la Controleur/ || echo 'Pas de Controleur'"
    
    # Test personnalisÃ© (si existe)
    - echo "ğŸ” Test personnalisÃ©..."
    - if docker-compose exec -T apache sh -c "[ -f 'tests/test_basic.php' ]"; then
        docker-compose exec -T apache php tests/test_basic.php
      else
        echo "ğŸ“ CrÃ©ation test basique..."
        docker-compose exec -T apache sh -c "echo '<?php echo \"âœ… GitLab CI/CD fonctionne avec Docker Compose!\\n\"; ?>' > /tmp/test_gitlab.php && php /tmp/test_gitlab.php"
      fi
    
    # Nettoyage (toujours exÃ©cuter)
    - echo "ğŸ§¹ Nettoyage..."
    - docker-compose down || true
    
    - echo "ğŸ‰ PIPELINE TERMINÃ‰ !"
  only:
    - main
    - merge_requests