stages:
  - test

test:
  stage: test
  image: php:8.1-apache
  services:
    - mysql:8.0
  variables:
    MYSQL_ROOT_PASSWORD: root
    MYSQL_DATABASE: monblog
    MYSQL_SSL_MODE: DISABLED  # â† DÃ‰SACTIVER SSL POUR LES TESTS CI
  before_script:
    - apt-get update && apt-get install -y default-mysql-client
  script:
    - echo "ğŸš€ DÃ©marrage des tests..."
    
    # Test 1: PHP
    - echo "âœ… PHP Version:"
    - php --version
    
    # Test 2: MySQL (avec --ssl-mode=DISABLED)
    - echo "âœ… Test MySQL..."
    - mysql -h mysql -uroot -proot --ssl-mode=DISABLED -e "SHOW DATABASES;"
    
    # Test 3: CrÃ©ation base (avec --ssl-mode=DISABLED)
    - echo "âœ… CrÃ©ation base de donnÃ©es..."
    - mysql -h mysql -uroot -proot --ssl-mode=DISABLED -e "CREATE DATABASE IF NOT EXISTS monblog; USE monblog; SELECT 'Base prÃªte' as status;"
    
    # Test 4: Extensions PHP
    - echo "âœ… VÃ©rification extensions..."
    - |
      php -r '
      echo extension_loaded("mysqli") ? "âœ… MySQLi activÃ©\n" : "âŒ MySQLi manquant\n";
      echo extension_loaded("pdo_mysql") ? "âœ… PDO MySQL activÃ©\n" : "âŒ PDO MySQL manquant\n";
      '
    
    # Test 5: Fichiers projet
    - echo "âœ… Structure projet..."
    - ls -la
    
    # Test 6: Connexion PHP Ã  MySQL
    - echo "âœ… Test connexion PHP/MySQL..."
    - |
      php -r '
      try {
        // DÃ©sactiver SSL pour la connexion PDO
        $options = [
          PDO::MYSQL_ATTR_SSL_CA => false,
          PDO::MYSQL_ATTR_SSL_VERIFY_SERVER_CERT => false,
        ];
        
        $pdo = new PDO("mysql:host=mysql;dbname=monblog", "root", "root", $options);
        echo "âœ… Connexion PHP/MySQL rÃ©ussie\n";
        
        // Tester une requÃªte simple
        $stmt = $pdo->query("SELECT 1 as test");
        $result = $stmt->fetch();
        echo "âœ… RequÃªte SQL fonctionne: " . $result["test"] . "\n";
      } catch (PDOException $e) {
        echo "âŒ Erreur connexion: " . $e->getMessage() . "\n";
      }
      '
    
    - echo "ğŸ‰ Tous les tests passÃ©s !"
  only:
    - main