stages:

  - test
  - deploy

test-application:
  stage: test
  image: php:8.1-apache
  services:
    - mysql:8.0
  variables:
    MYSQL_ROOT_PASSWORD: root
    MYSQL_DATABASE: monblog
    DB_HOST: mysql
  before_script:
    - apt-get update && apt-get install -y curl default-mysql-client
  script:
    # Tests basiques
    - php --version
    - ls -la
    
    # Test MySQL
    - mysql -h mysql -uroot -proot -e "SHOW DATABASES;"
    
    # Test PHP MySQL
    - php -r "echo extension_loaded('mysqli') ? '‚úÖ MySQLi OK\n' : '‚ö†Ô∏è MySQLi manquant\n';"
    - php -r "echo extension_loaded('pdo_mysql') ? '‚úÖ PDO MySQL OK\n' : '‚ö†Ô∏è PDO MySQL manquant\n';"
    
    # Test simple
    - php -r "echo 'üéâ GitLab CI/CD avec MySQL fonctionne !\n';"
  only:
    - main


deploy-notify:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Pipeline r√©ussi - Pr√™t pour d√©ploiement"
  only:
    - main
  when: manual
