stages:
  - test
  - deploy

variables:
  DOCKER_IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"

test-application:
  stage: test
  image: php:8.1-apache
  script:
    - echo "üöÄ Tests de l'application..."
    
    # Tests PHP
    - php --version
    
    # V√©rification extensions
    - |
      php -r '
      $required = ["mysqli", "pdo_mysql"];
      foreach($required as $ext) {
        if(extension_loaded($ext)) {
          echo "‚úÖ $ext activ√©\n";
        } else {
          echo "‚ùå $ext manquant\n";
        }
      }
      '
    
    # V√©rification fichiers
    - ls -la
    
    - echo "üéâ Tests r√©ussis !"
  only:
    - main

docker-hub-instructions:
  stage: deploy
  image: alpine:latest
  script:
    - echo "üìã INSTRUCTIONS POUR DOCKER HUB :"
    - echo ""
    - echo "1. Build l'image localement :"
    - echo "   docker build -t $DOCKERHUB_IMAGE:$DOCKER_IMAGE_TAG ."
    - echo ""
    - echo "2. Tag pour latest :"
    - echo "   docker tag $DOCKERHUB_IMAGE:$DOCKER_IMAGE_TAG $DOCKERHUB_IMAGE:latest"
    - echo ""
    - echo "3. Login √† Docker Hub :"
    - echo "   docker login -u $DOCKERHUB_USERNAME"
    - echo ""
    - echo "4. Push les images :"
    - echo "   docker push $DOCKERHUB_IMAGE:$DOCKER_IMAGE_TAG"
    - echo "   docker push $DOCKERHUB_IMAGE:latest"
    - echo ""
    - echo "‚úÖ Instructions g√©n√©r√©es"
  only:
    - main
  when: manual